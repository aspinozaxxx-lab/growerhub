рџ§© РћС‚С‡С‘С‚ Рѕ СЂРµС„Р°РєС‚РѕСЂРёРЅРіРµ MQTT-РїРѕРґСЃРёСЃС‚РµРјС‹ GrowerHub

Р”Р°С‚Р° Р·Р°РІРµСЂС€РµРЅРёСЏ: 30 РѕРєС‚СЏР±СЂСЏ 2025
РђРІС‚РѕСЂ: РћР»РµРі (GrowerHub)
РСЃРїРѕР»РЅРёС‚РµР»СЊ: Codex РїРѕРґ СѓРїСЂР°РІР»РµРЅРёРµРј ChatGPT (GPT-5)
РџСЂРѕРґРѕР»Р¶РёС‚РµР»СЊРЅРѕСЃС‚СЊ: 2 РёС‚РµСЂР°С†РёРё (РїРµСЂРІР°СЏ РЅРµСѓРґР°С‡РЅР°СЏ, РІС‚РѕСЂР°СЏ Р·Р°РІРµСЂС€РµРЅР° СѓСЃРїРµС€РЅРѕ)

рџЋЇ Р¦РµР»СЊ

РџСЂРёРІРµСЃС‚Рё MQTT-РїРѕРґСЃРёСЃС‚РµРјСѓ Рє СЃС‚СЂСѓРєС‚СѓСЂРёСЂРѕРІР°РЅРЅРѕР№ Р°СЂС…РёС‚РµРєС‚СѓСЂРµ, РєРѕС‚РѕСЂР°СЏ:

РёР·РѕР»РёСЂСѓРµС‚ Р»РѕРіРёРєСѓ СЂР°Р±РѕС‚С‹ СЃ Р±СЂРѕРєРµСЂРѕРј РѕС‚ Р±РёР·РЅРµСЃ-СѓСЂРѕРІРЅСЏ FastAPI,

СѓРїСЂРѕС‰Р°РµС‚ С‚РµСЃС‚РёСЂРѕРІР°РЅРёРµ Рё РїРѕРґРґРµСЂР¶РєСѓ,

СѓСЃС‚СЂР°РЅСЏРµС‚ РґСѓР±Р»РёСЂРѕРІР°РЅРёРµ РєРѕРґР° Рё РіР»РѕР±Р°Р»СЊРЅС‹Рµ СЃРёРЅРіР»С‚РѕРЅС‹,

СЃРѕС…СЂР°РЅСЏРµС‚ СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚СЊ СЃ СЃСѓС‰РµСЃС‚РІСѓСЋС‰РµР№ РїСЂРѕС€РёРІРєРѕР№ СѓСЃС‚СЂРѕР№СЃС‚РІ.

рџ“¦ Р§С‚Рѕ Р±С‹Р»Рѕ РґРѕ СЂРµС„Р°РєС‚РѕСЂРёРЅРіР°

MQTT-РєРѕРґ Р±С‹Р» СЂР°СЃРїСЂРµРґРµР»С‘РЅ РїРѕ РЅРµСЃРєРѕР»СЊРєРёРј С„Р°Р№Р»Р°Рј РІ РєРѕСЂРЅРµ server/:

Р¤Р°Р№Р»	Р РѕР»СЊ
mqtt_protocol.py	СЃС…РµРјС‹ РєРѕРјР°РЅРґ Рё СЃРѕСЃС‚РѕСЏРЅРёР№, СЃРµСЂРёР°Р»РёР·Р°С†РёСЏ
mqtt_publisher.py	РїСѓР±Р»РёРєР°С†РёСЏ РєРѕРјР°РЅРґ С‡РµСЂРµР· paho-mqtt
mqtt_subscriber.py	РґРІР° РїРѕРґРїРёСЃС‡РёРєР° (ACK Рё retained state)
ack_store.py	in-memory С…СЂР°РЅРёР»РёС‰Рµ РїРѕРґС‚РІРµСЂР¶РґРµРЅРёР№
device_shadow.py	С‚РµРЅРµРІРѕРµ СЃРѕСЃС‚РѕСЏРЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІ
api_manual_watering.py	FastAPI-СЂРѕСѓС‚РµСЂ СЂСѓС‡РЅРѕРіРѕ РїРѕР»РёРІР°
app/main.py	РёРЅРёС†РёР°Р»РёР·Р°С†РёСЏ MQTT-РєРѕРјРїРѕРЅРµРЅС‚РѕРІ

РџСЂРѕР±Р»РµРјС‹:

Р”СѓР±Р»РёСЂРѕРІР°РЅРёРµ РёРјРїРѕСЂС‚Р° Рё РёРЅРёС†РёР°Р»РёР·Р°С†РёРё.

РЎРјРµС€РµРЅРёРµ СѓСЂРѕРІРЅРµР№ (MQTT-Р»РѕРіРёРєР° РІ API-РєРѕРґРµ).

РњРЅРѕРіРѕ РіР»РѕР±Р°Р»СЊРЅС‹С… СЃРёРЅРіР»С‚РѕРЅРѕРІ Рё вЂњРјР°РіРёС‡РµСЃРєРёС…вЂќ Р·Р°РІРёСЃРёРјРѕСЃС‚РµР№.

РўСЂСѓРґРЅРѕ СЂР°СЃС€РёСЂСЏС‚СЊ: Р»СЋР±РѕРµ РЅРѕРІРѕРµ СЃРѕРѕР±С‰РµРЅРёРµ С‚СЂРµР±РѕРІР°Р»Рѕ РїСЂР°РІРєРё РЅРµСЃРєРѕР»СЊРєРёС… С„Р°Р№Р»РѕРІ.

РўРµСЃС‚С‹ РѕРїРёСЂР°Р»РёСЃСЊ РЅР° РІРЅСѓС‚СЂРµРЅРЅРёРµ РґРµС‚Р°Р»Рё РјРѕРґСѓР»РµР№.

рџ§± РќРѕРІР°СЏ СЃС‚СЂСѓРєС‚СѓСЂР°

РўРµРїРµСЂСЊ РІРµСЃСЊ РєРѕРґ MQTT РІС‹РЅРµСЃРµРЅ РІ РѕС‚РґРµР»СЊРЅС‹Р№ РїР°РєРµС‚
growerhub/server/app/mqtt/, РІРєР»СЋС‡Р°СЋС‰РёР№ СЃР»РµРґСѓСЋС‰РёРµ РјРѕРґСѓР»Рё:

mqtt/
в”њв”Ђв”Ђ __init__.py
в”њв”Ђв”Ђ config.py          # С‡С‚РµРЅРёРµ ENV Рё РЅР°СЃС‚СЂРѕР№РєР° MQTT
в”њв”Ђв”Ђ interfaces.py      # РёРЅС‚РµСЂС„РµР№СЃС‹ Рё РїСЂРѕС‚РѕРєРѕР»С‹ (IMqttPublisher Рё РґСЂ.)
в”њв”Ђв”Ђ topics.py          # С€Р°Р±Р»РѕРЅС‹ Рё РіРµРЅРµСЂР°С‚РѕСЂС‹ MQTT-С‚РѕРїРёРєРѕРІ
в”њв”Ђв”Ђ serialization.py   # Pydantic-РјРѕРґРµР»Рё Рё (РґРµ)СЃРµСЂРёР°Р»РёР·Р°С†РёСЏ JSON
в”њв”Ђв”Ђ client.py          # РєР»РёРµРЅС‚СЃРєР°СЏ РѕР±С‘СЂС‚РєР° РЅР°Рґ paho-mqtt
в”њв”Ђв”Ђ router.py          # РјР°СЂС€СЂСѓС‚РёР·Р°С†РёСЏ РІС…РѕРґСЏС‰РёС… СЃРѕРѕР±С‰РµРЅРёР№
в”њв”Ђв”Ђ lifecycle.py       # РёРЅРёС†РёР°Р»РёР·Р°С†РёСЏ/Р·Р°РІРµСЂС€РµРЅРёРµ РІСЃРµС… MQTT-РєРѕРјРїРѕРЅРµРЅС‚РѕРІ
в”њв”Ђв”Ђ store.py           # AckStore Рё DeviceShadowStore
в””в”Ђв”Ђ handlers/
    в”њв”Ђв”Ђ ack.py         # РѕР±СЂР°Р±РѕС‚РєР° СЃРѕРѕР±С‰РµРЅРёР№ ACK
    в””в”Ђв”Ђ device_state.py# РѕР±СЂР°Р±РѕС‚РєР° retained state СѓСЃС‚СЂРѕР№СЃС‚РІ


РўРµРїРµСЂСЊ FastAPI Рё СЃРµСЂРІРёСЃРЅР°СЏ Р»РѕРіРёРєР° РѕР±СЂР°С‰Р°СЋС‚СЃСЏ Рє MQTT-СЃР»РѕСЋ С‡РµСЂРµР· РёРЅС‚РµСЂС„РµР№СЃС‹ (IMqttPublisher, AckStore, DeviceShadowStore) Рё С„Р°СЃР°Рґ lifecycle.

рџ”„ РћСЃРЅРѕРІРЅС‹Рµ РёР·РјРµРЅРµРЅРёСЏ РїРѕ С€Р°РіР°Рј

РљР°СЂРєР°СЃ Рё РїСЂРѕС‚РѕРєРѕР» вЂ” СЃРѕР·РґР°РЅ РїР°РєРµС‚ app/mqtt, РїРµСЂРµРЅРµСЃРµРЅС‹ СЃС…РµРјС‹ Рё С‚РѕРїРёРєРё РёР· mqtt_protocol.py.

Publisher Рё lifecycle вЂ” РІС‹РЅРµСЃРµРЅС‹ РїСѓР±Р»РёРєР°С†РёРё Рё СѓРїСЂР°РІР»РµРЅРёРµ РєР»РёРµРЅС‚РѕРј РёР· mqtt_publisher.py.

Subscribers Рё handlers вЂ” Р»РѕРіРёРєР° РїСЂРёС‘РјР° СЃРѕРѕР±С‰РµРЅРёР№ РІС‹РЅРµСЃРµРЅР° РІ router.py Рё handlers/.

Stores вЂ” РѕР±СЉРµРґРёРЅРµРЅС‹ AckStore Рё DeviceShadowStore РІ store.py.

Config вЂ” С†РµРЅС‚СЂР°Р»РёР·РѕРІР°РЅРѕ С‡С‚РµРЅРёРµ РІСЃРµС… MQTT-РїРµСЂРµРјРµРЅРЅС‹С… РѕРєСЂСѓР¶РµРЅРёСЏ.

Docs & Tests вЂ” С‚РµСЃС‚С‹ Рё РґРѕРєСѓРјРµРЅС‚Р°С†РёСЏ СЃРєРѕСЂСЂРµРєС‚РёСЂРѕРІР°РЅС‹, РёРјРїРѕСЂС‚С‹ РѕР±РЅРѕРІР»РµРЅС‹.

РЈРґР°Р»РµРЅРёРµ Р»РµРіР°СЃРё-РєРѕРґР° вЂ” СЃС‚Р°СЂС‹Рµ С„Р°Р№Р»С‹ server/mqtt_*.py СѓРґР°Р»РµРЅС‹, app/main.py Рё api_manual_watering.py РїРµСЂРµРІРµРґРµРЅС‹ РЅР° РЅРѕРІС‹Рµ РёРЅС‚РµСЂС„РµР№СЃС‹.

Р”РѕРєСѓРјРµРЅС‚Р°С†РёСЏ вЂ” docs/manual_watering_protocol.md РѕР±РЅРѕРІР»С‘РЅ, РѕС‚СЂР°Р¶Р°РµС‚ РЅРѕРІСѓСЋ Р°СЂС…РёС‚РµРєС‚СѓСЂСѓ (Р±РµР· РёР·РјРµРЅРµРЅРёСЏ РїСЂРѕС‚РѕРєРѕР»Р°).

вљ™пёЏ РўРµС…РЅРёС‡РµСЃРєРёРµ СЂРµР·СѓР»СЊС‚Р°С‚С‹

вњ… Р’СЃРµ 33 С‚РµСЃС‚Р° РїСЂРѕС€Р»Рё СѓСЃРїРµС€РЅРѕ (pytest -q Р·РµР»С‘РЅС‹Р№).

вњ… Backward-СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚СЊ СЃРѕС…СЂР°РЅРµРЅР°: РїСЂРѕС€РёРІРєР° ESP32 РЅРµ С‚СЂРµР±СѓРµС‚ РёР·РјРµРЅРµРЅРёР№.

вњ… РџСЂРѕС‚РѕРєРѕР» (cmd, ack, state) Рё С‚РѕРїРёРєРё РїРѕР»РЅРѕСЃС‚СЊСЋ СЃРѕРІРїР°РґР°СЋС‚ СЃ РїСЂРµР¶РЅРµР№ РґРѕРєСѓРјРµРЅС‚Р°С†РёРµР№.

вњ… ENV-РїРµСЂРµРјРµРЅРЅС‹Рµ (MQTT_HOST, MQTT_PORT, MQTT_USERNAME, Рё С‚.Рґ.) РѕСЃС‚Р°Р»РёСЃСЊ РїСЂРµР¶РЅРёРјРё.

вљ пёЏ Deprecation warnings FastAPI/on_event Рё paho Callback API v1 РѕСЃС‚Р°СЋС‚СЃСЏ, СЂРµС€Р°С‚СЊ РѕС‚РґРµР»СЊРЅРѕ.

рџ“„ Р’ changelog.md Р·Р°С„РёРєСЃРёСЂРѕРІР°РЅ РёС‚РѕРіРѕРІС‹Р№ С€Р°Рі РјРёРіСЂР°С†РёРё (step 8).

рџ§  Р­С„С„РµРєС‚С‹ Рё РїСЂРµРёРјСѓС‰РµСЃС‚РІР°
Р‘С‹Р»Рѕ	РЎС‚Р°Р»Рѕ
РќРµСЃРєРѕР»СЊРєРѕ РЅРµСЃРІСЏР·Р°РЅРЅС‹С… С„Р°Р№Р»РѕРІ	Р•РґРёРЅС‹Р№ СЃРµСЂРІРёСЃРЅС‹Р№ РїР°РєРµС‚ app/mqtt
Р“Р»РѕР±Р°Р»СЊРЅС‹Рµ СЃРёРЅРіР»С‚РѕРЅС‹	Р§С‘С‚РєРёР№ lifecycle Рё С„Р°Р±СЂРёРєРё
Р—Р°РІРёСЃРёРјРѕСЃС‚Рё API в†’ СЂРµР°Р»РёР·Р°С†РёСЏ	API С‚РµРїРµСЂСЊ Р·Р°РІРёСЃРёС‚ РѕС‚ РёРЅС‚РµСЂС„РµР№СЃРѕРІ
Р Р°Р·СЂРѕР·РЅРµРЅРЅС‹Рµ С‚РµСЃС‚С‹	Р•РґРёРЅР°СЏ СЃС‚СЂСѓРєС‚СѓСЂР° Рё РїРѕРЅСЏС‚РЅС‹Рµ РіСЂР°РЅРёС†С‹
РўСЂСѓРґРЅРѕ РґРѕР±Р°РІР»СЏС‚СЊ РЅРѕРІС‹Рµ РєРѕРјР°РЅРґС‹	РњРѕР¶РЅРѕ РґРѕР±Р°РІР»СЏС‚СЊ РЅРѕРІС‹Рµ handlers Р±РµР· РёР·РјРµРЅРµРЅРёСЏ РѕСЃС‚Р°Р»СЊРЅРѕРіРѕ РєРѕРґР°
рџ“ РЎР»РµРґСѓСЋС‰РёРµ С€Р°РіРё (РїСЂРµРґР»РѕР¶РµРЅРёСЏ)

Р Р°СЃСЃРјРѕС‚СЂРµС‚СЊ РїРµСЂРµС…РѕРґ РЅР° asyncio-mqtt РґР»СЏ РїРѕР»РЅРѕР№ Р°СЃРёРЅС…СЂРѕРЅРЅРѕР№ РёРЅС‚РµРіСЂР°С†РёРё СЃ FastAPI (Р±РµР· С„РѕРЅРѕРІС‹С… РїРѕС‚РѕРєРѕРІ).

Р”РѕР±Р°РІРёС‚СЊ РјРµС‚СЂРёРєРё Рё Р»РѕРіРёРєСѓ backoff/reconnect (РЅР°РїСЂРёРјРµСЂ, С‡РµСЂРµР· Prometheus).

Р Р°СЃС€РёСЂРёС‚СЊ С‚РµСЃС‚С‹ РЅР° РїРѕС‚РµСЂСЋ СЃРѕРµРґРёРЅРµРЅРёСЏ Рё РїРѕРІС‚РѕСЂРЅС‹Рµ РїСѓР±Р»РёРєР°С†РёРё QoS1.

РЎРѕРєСЂР°С‚РёС‚СЊ РІСЂРµРјСЏ С‚РµСЃС‚РѕРІ (РґРѕР±Р°РІРёС‚СЊ pytest-xdist РёР»Рё СѓРјРµРЅСЊС€РёС‚СЊ Р·Р°РґРµСЂР¶РєРё).

РћР±РЅРѕРІРёС‚СЊ Ansible-СЂРѕР»Рё, С‡С‚РѕР±С‹ Р·РЅР°С‡РµРЅРёРµ DEVICE_ONLINE_THRESHOLD_S С‡РёС‚Р°Р»РѕСЃСЊ РєРѕСЂСЂРµРєС‚РЅРѕ РёР· ENV.

рџЏЃ Р’С‹РІРѕРґ

Р РµС„Р°РєС‚РѕСЂРёРЅРі РІС‹РїРѕР»РЅРµРЅ СѓСЃРїРµС€РЅРѕ. MQTT-СЃР»РѕР№ СЃС‚Р°Р» РёР·РѕР»РёСЂРѕРІР°РЅРЅС‹Рј, С‚РµСЃС‚РёСЂСѓРµРјС‹Рј Рё СЂР°СЃС€РёСЂСЏРµРјС‹Рј.
РџСЂРѕРµРєС‚ С‚РµРїРµСЂСЊ РіРѕС‚РѕРІ Рє РґРѕР±Р°РІР»РµРЅРёСЋ РЅРѕРІС‹С… С‚РёРїРѕРІ СѓСЃС‚СЂРѕР№СЃС‚РІ Рё РєРѕРјР°РЅРґ Р±РµР· РёР·РјРµРЅРµРЅРёСЏ Р±Р°Р·РѕРІРѕР№ Р°СЂС…РёС‚РµРєС‚СѓСЂС‹.

вЂњРҐРѕСЂРѕС€Р°СЏ Р°СЂС…РёС‚РµРєС‚СѓСЂР° вЂ” С‚Р°, С‡С‚Рѕ РЅРµ РјРµС€Р°РµС‚ СЂР°Р·РІРёРІР°С‚СЊСЃСЏ.вЂќ
вЂ” РїСЂРёРЅС†РёРї, РЅР° РєРѕС‚РѕСЂРѕРј С‚РµРїРµСЂСЊ РїРѕСЃС‚СЂРѕРµРЅ MQTT-РјРѕРґСѓР»СЊ GrowerHub.
