üß© –û—Ç—á—ë—Ç –æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ MQTT-–ø–æ–¥—Å–∏—Å—Ç–µ–º—ã GrowerHub

–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: 30 –æ–∫—Ç—è–±—Ä—è 2025
–ê–≤—Ç–æ—Ä: –û–ª–µ–≥ (GrowerHub)
–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: Codex –ø–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º ChatGPT (GPT-5)
–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 2 –∏—Ç–µ—Ä–∞—Ü–∏–∏ (–ø–µ—Ä–≤–∞—è –Ω–µ—É–¥–∞—á–Ω–∞—è, –≤—Ç–æ—Ä–∞—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ)

üéØ –¶–µ–ª—å

–ü—Ä–∏–≤–µ—Å—Ç–∏ MQTT-–ø–æ–¥—Å–∏—Å—Ç–µ–º—É –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –∫–æ—Ç–æ—Ä–∞—è:

–∏–∑–æ–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å –±—Ä–æ–∫–µ—Ä–æ–º –æ—Ç –±–∏–∑–Ω–µ—Å-—É—Ä–æ–≤–Ω—è FastAPI,

—É–ø—Ä–æ—â–∞–µ—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É,

—É—Å—Ç—Ä–∞–Ω—è–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–∏–Ω–≥–ª—Ç–æ–Ω—ã,

—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø—Ä–æ—à–∏–≤–∫–æ–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤.

üì¶ –ß—Ç–æ –±—ã–ª–æ –¥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

MQTT-–∫–æ–¥ –±—ã–ª —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Ñ–∞–π–ª–∞–º –≤ –∫–æ—Ä–Ω–µ server/:

–§–∞–π–ª	–†–æ–ª—å
mqtt_protocol.py	—Å—Ö–µ–º—ã –∫–æ–º–∞–Ω–¥ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π, —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
mqtt_publisher.py	–ø—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ paho-mqtt
mqtt_subscriber.py	–¥–≤–∞ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ (ACK –∏ retained state)
ack_store.py	in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
device_shadow.py	—Ç–µ–Ω–µ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
api_manual_watering.py	FastAPI-—Ä–æ—É—Ç–µ—Ä —Ä—É—á–Ω–æ–≥–æ –ø–æ–ª–∏–≤–∞
app/main.py	–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MQTT-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

–ü—Ä–æ–±–ª–µ–º—ã:

–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.

–°–º–µ—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π (MQTT-–ª–æ–≥–∏–∫–∞ –≤ API-–∫–æ–¥–µ).

–ú–Ω–æ–≥–æ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–∏–Ω–≥–ª—Ç–æ–Ω–æ–≤ –∏ ‚Äú–º–∞–≥–∏—á–µ—Å–∫–∏—Ö‚Äù –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

–¢—Ä—É–¥–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å: –ª—é–±–æ–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–ª–æ –ø—Ä–∞–≤–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤.

–¢–µ—Å—Ç—ã –æ–ø–∏—Ä–∞–ª–∏—Å—å –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ –º–æ–¥—É–ª–µ–π.

üß± –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–¢–µ–ø–µ—Ä—å –≤–µ—Å—å –∫–æ–¥ MQTT –≤—ã–Ω–µ—Å–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–∞–∫–µ—Ç
growerhub/server/service/mqtt/, –≤–∫–ª—é—á–∞—é—â–∏–π —Å–ª–µ–¥—É—é—â–∏–µ –º–æ–¥—É–ª–∏:

mqtt/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ config.py          # —á—Ç–µ–Ω–∏–µ ENV –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ MQTT
‚îú‚îÄ‚îÄ interfaces.py      # –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã (IMqttPublisher –∏ –¥—Ä.)
‚îú‚îÄ‚îÄ topics.py          # —à–∞–±–ª–æ–Ω—ã –∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã MQTT-—Ç–æ–ø–∏–∫–æ–≤
‚îú‚îÄ‚îÄ serialization.py   # Pydantic-–º–æ–¥–µ–ª–∏ –∏ (–¥–µ)—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è JSON
‚îú‚îÄ‚îÄ client.py          # –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –æ–±—ë—Ä—Ç–∫–∞ –Ω–∞–¥ paho-mqtt
‚îú‚îÄ‚îÄ router.py          # –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
‚îú‚îÄ‚îÄ lifecycle.py       # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è/–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—Å–µ—Ö MQTT-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ store.py           # AckStore –∏ DeviceShadowStore
‚îî‚îÄ‚îÄ handlers/
    ‚îú‚îÄ‚îÄ ack.py         # –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ACK
    ‚îî‚îÄ‚îÄ device_state.py# –æ–±—Ä–∞–±–æ—Ç–∫–∞ retained state —É—Å—Ç—Ä–æ–π—Å—Ç–≤


–¢–µ–ø–µ—Ä—å FastAPI –∏ —Å–µ—Ä–≤–∏—Å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ MQTT-—Å–ª–æ—é —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã (IMqttPublisher, AckStore, DeviceShadowStore) –∏ —Ñ–∞—Å–∞–¥ lifecycle.

üîÑ –û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ —à–∞–≥–∞–º

–ö–∞—Ä–∫–∞—Å –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª ‚Äî —Å–æ–∑–¥–∞–Ω –ø–∞–∫–µ—Ç service/mqtt, –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã —Å—Ö–µ–º—ã –∏ —Ç–æ–ø–∏–∫–∏ –∏–∑ mqtt_protocol.py.

Publisher –∏ lifecycle ‚Äî –≤—ã–Ω–µ—Å–µ–Ω—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–º –∏–∑ mqtt_publisher.py.

Subscribers –∏ handlers ‚Äî –ª–æ–≥–∏–∫–∞ –ø—Ä–∏—ë–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ router.py –∏ handlers/.

Stores ‚Äî –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã AckStore –∏ DeviceShadowStore –≤ store.py.

Config ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö MQTT-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.

Docs & Tests ‚Äî —Ç–µ—Å—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã, –∏–º–ø–æ—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã.

–£–¥–∞–ª–µ–Ω–∏–µ –ª–µ–≥–∞—Å–∏-–∫–æ–¥–∞ ‚Äî —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã server/mqtt_*.py —É–¥–∞–ª–µ–Ω—ã, app/main.py –∏ api_manual_watering.py –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ –Ω–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã.

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è ‚Äî docs/manual_watering_protocol.md –æ–±–Ω–æ–≤–ª—ë–Ω, –æ—Ç—Ä–∞–∂–∞–µ—Ç –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞).

‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

‚úÖ –í—Å–µ 33 —Ç–µ—Å—Ç–∞ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ (pytest -q –∑–µ–ª—ë–Ω—ã–π).

‚úÖ Backward-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: –ø—Ä–æ—à–∏–≤–∫–∞ ESP32 –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π.

‚úÖ –ü—Ä–æ—Ç–æ–∫–æ–ª (cmd, ack, state) –∏ —Ç–æ–ø–∏–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –ø—Ä–µ–∂–Ω–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π.

‚úÖ ENV-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (MQTT_HOST, MQTT_PORT, MQTT_USERNAME, –∏ —Ç.–¥.) –æ—Å—Ç–∞–ª–∏—Å—å –ø—Ä–µ–∂–Ω–∏–º–∏.

‚ö†Ô∏è Deprecation warnings FastAPI/on_event –∏ paho Callback API v1 –æ—Å—Ç–∞—é—Ç—Å—è, —Ä–µ—à–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ.

üìÑ –í changelog.md –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –∏—Ç–æ–≥–æ–≤—ã–π —à–∞–≥ –º–∏–≥—Ä–∞—Ü–∏–∏ (step 8).

üß† –≠—Ñ—Ñ–µ–∫—Ç—ã –∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
–ë—ã–ª–æ	–°—Ç–∞–ª–æ
–ù–µ—Å–∫–æ–ª—å–∫–æ –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤	–ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å–Ω—ã–π –ø–∞–∫–µ—Ç service/mqtt
–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–∏–Ω–≥–ª—Ç–æ–Ω—ã	–ß—ë—Ç–∫–∏–π lifecycle –∏ —Ñ–∞–±—Ä–∏–∫–∏
–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ API ‚Üí —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è	API —Ç–µ–ø–µ—Ä—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
–†–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã	–ï–¥–∏–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ø–æ–Ω—è—Ç–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
–¢—Ä—É–¥–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã	–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ handlers –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
üìò –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)

–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ asyncio-mqtt –¥–ª—è –ø–æ–ª–Ω–æ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å FastAPI (–±–µ–∑ —Ñ–æ–Ω–æ–≤—ã—Ö –ø–æ—Ç–æ–∫–æ–≤).

–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ –ª–æ–≥–∏–∫—É backoff/reconnect (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ Prometheus).

–†–∞—Å—à–∏—Ä–∏—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ –ø–æ—Ç–µ—Ä—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ QoS1.

–°–æ–∫—Ä–∞—Ç–∏—Ç—å –≤—Ä–µ–º—è —Ç–µ—Å—Ç–æ–≤ (–¥–æ–±–∞–≤–∏—Ç—å pytest-xdist –∏–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏).

–û–±–Ω–æ–≤–∏—Ç—å Ansible-—Ä–æ–ª–∏, —á—Ç–æ–±—ã –∑–Ω–∞—á–µ–Ω–∏–µ DEVICE_ONLINE_THRESHOLD_S —á–∏—Ç–∞–ª–æ—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑ ENV.

üèÅ –í—ã–≤–æ–¥

–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ. MQTT-—Å–ª–æ–π —Å—Ç–∞–ª –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–º –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–º.
–ü—Ä–æ–µ–∫—Ç —Ç–µ–ø–µ—Ä—å –≥–æ—Ç–æ–≤ –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –∫–æ–º–∞–Ω–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

‚Äú–•–æ—Ä–æ—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ ‚Äî —Ç–∞, —á—Ç–æ –Ω–µ –º–µ—à–∞–µ—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è.‚Äù
‚Äî –ø—Ä–∏–Ω—Ü–∏–ø, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º —Ç–µ–ø–µ—Ä—å –ø–æ—Å—Ç—Ä–æ–µ–Ω MQTT-–º–æ–¥—É–ª—å GrowerHub.