# Архитектурные правила

1. R-SYS-01: Домены - центр системы, адаптеры тонкие.
2. R-ADAPTER-01: 1 handler -> 1 facade operation. Один REST endpoint или MQTT consumer вызывает ровно одну публичную операцию Facade. Если нужно несколько доменных операций/доменов - создается отдельная composite use-case операция в фасаде/оркестраторе; адаптер все равно делает один вызов.
3. R-USECASE-01: Composite use-case размещается в фасаде домена-владельца сценария; если владельца нет, фасад одного из вовлечённых доменов агрегирует нужные вызовы. Адаптеры не вызывают несколько фасадов.
4. R-DOMAIN-01: Каждый домен имеет один публичный Facade как точку входа.
5. R-DOMAIN-02: Домены общаются только через Facade и контрактные типы. Прямой импорт внутренних классов домена другими доменами/адаптерами запрещен.
6. R-DOMAIN-03: Каждый домен организован по структуре facade/contract/engine/jpa:
   facade — единственная публичная точка входа домена (операции и границы транзакций);
   contract — экспортируемые типы, DTO и контракты, доступные адаптерам и другим доменам;
   engine — внутренняя бизнес-логика (сценарии, правила, расчёты), не предназначенная для прямого использования извне;
   jpa — сущности и репозитории домена, обеспечивающие постоянное хранение, также не предназначены для прямого доступа извне.
   Внешние модули (адаптеры и другие домены) взаимодействуют с доменом только через facade и contract. Прямой импорт engine и jpa извне домена запрещён.
   Примечание: так как engine и jpa располагаются в отдельных пакетах, их закрытость обеспечивается архитектурными правилами и тестами, а не только модификаторами доступа.
7. R-DOMAIN-04: Домен не зависит от адаптеров (api/mqtt).
8. R-SHARED-01: shared/common содержит только стабильные типы/DTO/утилиты; бизнес-логика и JPA entity запрещены.
9. R-ADAPTER-02: Адаптеры не содержат бизнес-логики и не имеют прямого доступа к DB.
10. R-ERROR-01: Внутри домена допустимы доменные исключения/ошибки, но на границе адаптера они мапятся в контрактные коды/DTO.
11. R-TRANSACTION-01: Транзакционные границы задаются и контролируются только на уровне операций facade. Пакеты engine и jpa работают в контексте транзакции, открытой фасадом. Адаптеры не открывают собственных транзакций.
12. R-BOUNDARY-01: Импорт внутренних пакетов домена извне запрещён: внешние модули не должны импортировать ru.growerhub.backend.<domain>.engine.. и ru.growerhub.backend.<domain>.jpa.... Для внешнего мира доступны только ru.growerhub.backend.<domain>.facade.. и ru.growerhub.backend.<domain>.contract....
13. R-CHANGE-01: Если фича не укладывается в RULES - сначала предложение изменения архитектуры/правил; ADR только если это исключение.
