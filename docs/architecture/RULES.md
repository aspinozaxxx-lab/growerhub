# Архитектурные правила

1. R-SYS-01: Домены - центр системы, адаптеры тонкие.
2. R-ADAPTER-01: 1 handler -> 1 facade operation. Один REST endpoint или MQTT consumer вызывает ровно одну публичную операцию Facade. Если нужно несколько доменных операций/доменов - создается отдельная composite use-case операция в фасаде/оркестраторе; адаптер все равно делает один вызов.
3. R-USECASE-01: Composite use-case размещается в фасаде домена-владельца сценария; если владельца нет, фасад одного из вовлечённых доменов агрегирует нужные вызовы. Адаптеры не вызывают несколько фасадов.
4. R-DOMAIN-01: Каждый домен имеет один публичный Facade как точку входа.
5. R-DOMAIN-02: Домены общаются только через Facade и контрактные типы. Прямой импорт внутренних классов домена другими доменами/адаптерами запрещен.
6. R-DOMAIN-03: Каждый домен организован так: public Facade размещается в корне пакета `ru.growerhub.backend.<domain>` (имя класса `*Facade`), а подпакеты `contract`, `engine` и `jpa` содержат соответственно контракты, бизнес-логику и сущности/репозитории. Все входы в домен идут через facade и контрактные типы; engine и jpa доступны только внутри своего домена и не импортируются извне.

   В корневом пакете домена `ru.growerhub.backend.<domain>` допускается только `*Facade` (и опционально `package-info.java`). Любые DTO/records/enums, используемые извне домена, должны жить в `ru.growerhub.backend.<domain>.contract`. Любые use-case/сервисы — в `engine`, сущности/репозитории — в `jpa`. Контроллеры/фильтры/конфиги/initializers/resources/gateways реализации не должны жить в домене: их место в адаптерах (`api`, `mqtt`) или конфигурации приложения.
7. R-DOMAIN-04: Домен не зависит от адаптеров (api/mqtt).
8. R-SHARED-01: shared/common содержит только стабильные типы/DTO/утилиты; бизнес-логика и JPA entity запрещены.
9. R-ADAPTER-02: Адаптеры не содержат бизнес-логики и не имеют прямого доступа к DB.
10. R-ERROR-01: Внутри домена допустимы доменные исключения/ошибки, но на границе адаптера они мапятся в контрактные коды/DTO.
11. R-TRANSACTION-01: Транзакционные границы задаются и контролируются только на уровне операций facade. Пакеты engine и jpa работают в контексте транзакции, открытой фасадом; адаптеры не открывают собственных транзакций.
12. R-BOUNDARY-01: Внешний импорт из домена разрешён только к `ru.growerhub.backend.<domain>.*Facade` и `ru.growerhub.backend.<domain>.contract..`. Импорт любых других классов из `ru.growerhub.backend.<domain>` (кроме `*Facade`) внешними модулями запрещён.
13. R-CHANGE-01: Если фича не укладывается в RULES - сначала предложение изменения архитектуры/правил; ADR только если это исключение.
