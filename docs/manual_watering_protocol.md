_РћР±РЅРѕРІР»РµРЅРѕ: 2025-10-26 вЂ” РѕРїРёСЃР°РЅРёРµ РїСЂРёРІРµРґРµРЅРѕ РІ СЃРѕРѕС‚РІРµС‚СЃС‚РІРёРµ СЃ РїСЂРѕС€РёРІРєРѕР№ ESP32 (С€Р°Рі 4)._ 

# Р СѓРєРѕРІРѕРґСЃС‚РІРѕ РїРѕ РїСЂРѕС‚РѕРєРѕР»Сѓ СЂСѓС‡РЅРѕРіРѕ РїРѕР»РёРІР°

## РћР±С‰РµРµ РѕРїРёСЃР°РЅРёРµ
GrowerHub вЂ” MVP СЃРёСЃС‚РµРјС‹ В«СѓРјРЅРѕРіРѕ РїРѕР»РёРІР°В». ESP32 РІ СЂРµР¶РёРјРµ СЂСѓС‡РЅРѕРіРѕ РїРѕР»РёРІР° СѓРїСЂР°РІР»СЏРµС‚ РЅР°СЃРѕСЃРѕРј РїРѕ РєРѕРјР°РЅРґР°Рј СЃРµСЂРІРµСЂР° FastAPI. РЎРІСЏР·СЊ СЃС‚СЂРѕРёС‚СЃСЏ РїРѕРІРµСЂС… MQTT (Mosquitto) СЃ РґРѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹РјРё HTTP-СЌРЅРґРїРѕРёРЅС‚Р°РјРё РґР»СЏ С„СЂРѕРЅС‚РµРЅРґР° `/static/manual_watering.html`.

## РџРѕРґРєР»СЋС‡РµРЅРёРµ Рё СѓСЃС‚РѕР№С‡РёРІРѕСЃС‚СЊ СЃРІСЏР·Рё
### Wi-Fi STA
- РЈСЃС‚СЂРѕР№СЃС‚РІРѕ СЂР°Р±РѕС‚Р°РµС‚ РІ СЂРµР¶РёРјРµ STA Рё РїРѕРґРєР»СЋС‡Р°РµС‚СЃСЏ Рє Р»РѕРєР°Р»СЊРЅРѕР№ С‚РѕС‡РєРµ РґРѕСЃС‚СѓРїР°.
- РџРѕСЃР»Рµ Р·Р°РіСЂСѓР·РєРё ESP32 Р·Р°РїСѓСЃРєР°РµС‚ РїСЂРѕС†РµСЃСЃ РїРѕРґРєР»СЋС‡РµРЅРёСЏ Рє Wi-Fi, Р·Р°С‚РµРј Рє MQTT-Р±СЂРѕРєРµСЂСѓ.

### MQTT (Mosquitto)
- Р‘СЂРѕРєРµСЂ: Mosquitto, РїРѕСЂС‚ `1883`.
- РђСѓС‚РµРЅС‚РёС„РёРєР°С†РёСЏ: `username=mosquitto-admin`, `password=qazwsxedc`.
- `clientId=<DEVICE_ID>` (РЅР°РїСЂРёРјРµСЂ, `ESP32_2C294C`). РРґРµРЅС‚РёС„РёРєР°С‚РѕСЂ СѓРЅРёРєР°Р»РµРЅ РґР»СЏ РєР°Р¶РґРѕРіРѕ СѓСЃС‚СЂРѕР№СЃС‚РІР° Рё РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ РІ РёРјРµРЅР°С… С‚РѕРїРёРєРѕРІ.
- QoS РІСЃРµС… РѕР±РјРµРЅРѕРІ вЂ” `1`.
- РџСЂРё СЂР°Р·СЂС‹РІРµ СЃРѕРµРґРёРЅРµРЅРёСЏ СѓСЃС‚СЂРѕР№СЃС‚РІРѕ РІРѕСЃСЃС‚Р°РЅР°РІР»РёРІР°РµС‚ MQTT-СЃРµСЃСЃРёСЋ Рё РїРѕРІС‚РѕСЂРЅРѕ РїСѓР±Р»РёРєСѓРµС‚ `state` СЃ `retain=true`, С‡С‚РѕР±С‹ СЃРµСЂРІРµСЂ РІРёРґРµР» Р°РєС‚СѓР°Р»СЊРЅРѕРµ С‚РµРЅРµРІР°СЏ СЃРѕСЃС‚РѕСЃС‚РѕСЏРЅРёРµ.

## MQTT-С‚РѕРїРёРєРё
| РќР°РїСЂР°РІР»РµРЅРёРµ | РўРѕРїРёРє | РћРїРёСЃР°РЅРёРµ | QoS | Retain |
| --- | --- | --- | --- | --- |
| РЎРµСЂРІРµСЂ в†’ РЈСЃС‚СЂРѕР№СЃС‚РІРѕ | `gh/dev/<DEVICE_ID>/cmd` | РљРѕРјР°РЅРґС‹ СѓРїСЂР°РІР»РµРЅРёСЏ РЅР°СЃРѕСЃРѕРј (`pump.start`, `pump.stop`) | 1 | false |
| РЈСЃС‚СЂРѕР№СЃС‚РІРѕ в†’ РЎРµСЂРІРµСЂ | `gh/dev/<DEVICE_ID>/ack` | РџРѕРґС‚РІРµСЂР¶РґРµРЅРёСЏ (ACK) РѕР±СЂР°Р±РѕС‚РєРё РєРѕРјР°РЅРґ | 1 | false |
| РЈСЃС‚СЂРѕР№СЃС‚РІРѕ в†’ РЎРµСЂРІРµСЂ | `gh/dev/<DEVICE_ID>/state` | Retained-СЃРЅРёРјРѕРє СЃРѕСЃС‚РѕСЏРЅРёСЏ СѓСЃС‚СЂРѕР№СЃС‚РІР° | 1 | true |

`<DEVICE_ID>` вЂ” СѓРЅРёРєР°Р»СЊРЅС‹Р№ РёРґРµРЅС‚РёС„РёРєР°С‚РѕСЂ РєРѕРЅРєСЂРµС‚РЅРѕРіРѕ РєРѕРЅС‚СЂРѕР»Р»РµСЂР° ESP32 (РЅР°РїСЂРёРјРµСЂ, `ESP32_2C294C`). РЎРµСЂРІРµСЂ Рё С„СЂРѕРЅС‚РµРЅРґ РёСЃРїРѕР»СЊР·СѓСЋС‚ РµРіРѕ, С‡С‚РѕР±С‹ РїРѕРґРїРёСЃС‹РІР°С‚СЊСЃСЏ РЅР° РЅСѓР¶РЅС‹Рµ С‚РѕРїРёРєРё.

## РЎРµСЂРІРµСЂРЅР°СЏ СЂРµР°Р»РёР·Р°С†РёСЏ MQTT-СЃР»РѕСЏ

РћСЃРЅРѕРІРЅР°СЏ Р»РѕРіРёРєР° СЂР°Р·РјРµС‰РµРЅР° РІ РєР°С‚Р°Р»РѕРіРµ `server/app/api/routers/mqtt/` Рё СЂР°Р·РґРµР»РµРЅР° РїРѕ РѕС‚РІРµС‚СЃС‚РІРµРЅРЅРѕСЃС‚СЏРј:

- `topics.py` вЂ” С€Р°Р±Р»РѕРЅС‹ Рё РіРµРЅРµСЂР°С‚РѕСЂС‹ С‚РѕРїРёРєРѕРІ `gh/dev/<DEVICE_ID>/(cmd|ack|state)`.
- `serialization.py` вЂ” Pydantic-РјРѕРґРµР»Рё РєРѕРјР°РЅРґ, ACK Рё С‚РµРЅРµРІС‹С… СЃРѕСЃС‚РѕСЏРЅРёР№; JSON-(РґРµ)СЃРµСЂРёР°Р»РёР·Р°С†РёСЏ.
- `client.py` вЂ” Р°РґР°РїС‚РµСЂ РЅР°Рґ `paho-mqtt` СЃ РїСѓР±Р»РёРєР°С†РёРµР№ QoS=1.
- `handlers/ack.py`, `handlers/device_state.py` вЂ” С„РёР»СЊС‚СЂС‹ С‚РѕРїРёРєРѕРІ Рё РїР°СЂСЃРёРЅРі payload РґР»СЏ РїРѕРґРїРёСЃС‡РёРєРѕРІ.
- `router.py` вЂ” РєР»Р°СЃСЃС‹ `MqttAckSubscriber` Рё `MqttStateSubscriber`, РјР°СЂС€СЂСѓС‚РёР·Р°С†РёСЏ РІС…РѕРґСЏС‰РёС… СЃРѕРѕР±С‰РµРЅРёР№.
- `store.py` вЂ” in-memory `AckStore` Рё `DeviceShadowStore`, РёСЃРїРѕР»СЊР·СѓРµРјС‹Рµ HTTP-СЃР»РѕРµРј.
- `lifecycle.py` вЂ” РµРґРёРЅС‹Рµ С‚РѕС‡РєРё `init/start/stop/shutdown` РґР»СЏ РїР°Р±Р»РёС€РµСЂР°, РїРѕРґРїРёСЃС‡РёРєРѕРІ Рё СЃС‚РѕСЂР°Р¶РµР№.

FastAPI-РїСЂРёР»РѕР¶РµРЅРёРµ (`server/app/main.py`) РІС‹Р·С‹РІР°РµС‚ `app.mqtt.lifecycle` РЅР° СЃС‚Р°СЂС‚Рµ Рё РѕСЃС‚Р°РЅРѕРІРєРµ, С‡С‚РѕР±С‹ РґРµСЂР¶Р°С‚СЊ РїРѕРґРєР»СЋС‡РµРЅРёРµ Рє Р±СЂРѕРєРµСЂСѓ Рё РѕР±РЅРѕРІР»СЏС‚СЊ СЃС‚РѕСЂС‹. API `/api/manual-watering/*` (`server/api_manual_watering.py`) РїРѕР»СѓС‡Р°РµС‚ Р·Р°РІРёСЃРёРјРѕСЃС‚Рё С‡РµСЂРµР· `app.mqtt.lifecycle` Рё `app.mqtt.store`: РїСѓР±Р»РёРєСѓРµС‚ РєРѕРјР°РЅРґС‹, С‡РёС‚Р°РµС‚ ACK Рё РїСЂРµРґСЃС‚Р°РІР»РµРЅРёРµ С‚РµРЅРµРІРѕРіРѕ СЃРѕСЃС‚РѕСЏРЅРёСЏ РґР»СЏ С„СЂРѕРЅС‚РµРЅРґР°.

## Р¤РѕСЂРјР°С‚С‹ СЃРѕРѕР±С‰РµРЅРёР№
### РљРѕРјР°РЅРґС‹ СЃРµСЂРІРµСЂР° (`gh/dev/<DEVICE_ID>/cmd`)
РЈСЃС‚СЂРѕР№СЃС‚РІРѕ РїРѕРґРґРµСЂР¶РёРІР°РµС‚ РґРІРµ РєРѕРјР°РЅРґС‹:

```json
{
  "type": "pump.start",
  "duration_s": 20,
  "correlation_id": "abc123"
}
```

```json
{
  "type": "pump.stop",
  "correlation_id": "abc124"
}
```

- `type` вЂ” С‚РёРї РєРѕРјР°РЅРґС‹ (`pump.start` РёР»Рё `pump.stop`).
- `duration_s` вЂ” РґР»РёС‚РµР»СЊРЅРѕСЃС‚СЊ СЃРµСЃСЃРёРё СЂСѓС‡РЅРѕРіРѕ РїРѕР»РёРІР° РІ СЃРµРєСѓРЅРґР°С… (РѕР±СЏР·Р°С‚РµР»РµРЅ РґР»СЏ `pump.start`).
- `correlation_id` вЂ” РјР°СЂРєРµСЂ Р·Р°РїСЂРѕСЃР°, РєРѕС‚РѕСЂС‹Р№ СЃРµСЂРІРµСЂ РІРѕР·РІСЂР°С‰Р°РµС‚ РїРѕР»СЊР·РѕРІР°С‚РµР»СЋ РґР»СЏ РѕР¶РёРґР°РЅРёСЏ ACK.

### РџРѕРґС‚РІРµСЂР¶РґРµРЅРёСЏ СѓСЃС‚СЂРѕР№СЃС‚РІР° (`gh/dev/<DEVICE_ID>/ack`)
ACK РїСѓР±Р»РёРєСѓРµС‚СЃСЏ Р±РµР· retain (РѕРґРЅРѕСЂР°Р·РѕРІРѕРµ РїРѕРґС‚РІРµСЂР¶РґРµРЅРёРµ) Рё РїРµСЂРµРґР°С‘С‚ СЂРµР·СѓР»СЊС‚Р°С‚ РѕР±СЂР°Р±РѕС‚РєРё РєРѕРјР°РЅРґС‹:

```json
{
  "correlation_id": "abc123",
  "result": "accepted",
  "status": "running"
}
```

```json
{
  "correlation_id": "abc124",
  "result": "accepted",
  "status": "idle"
}
```

```json
{
  "correlation_id": "abc123",
  "result": "error",
  "reason": "bad command format"
}
```

- `status` РїСЂРёРЅРёРјР°РµС‚ Р·РЅР°С‡РµРЅРёСЏ `running` РёР»Рё `idle` Рё РѕС‚СЂР°Р¶Р°РµС‚ С‚РµРєСѓС‰СѓСЋ СЂР°Р±РѕС‚Сѓ РЅР°СЃРѕСЃР°.
- `correlation_id` РїРѕР·РІРѕР»СЏРµС‚ СЃРµСЂРІРµСЂСѓ СЃРІСЏР·Р°С‚СЊ ACK СЃ РёСЃС…РѕРґРЅРѕР№ РєРѕРјР°РЅРґРѕР№ РїРѕР»СЊР·РѕРІР°С‚РµР»СЏ.
- Р’ СЃР»СѓС‡Р°Рµ РѕС€РёР±РѕРє РїРѕР»Рµ `reason` СЃРѕРґРµСЂР¶РёС‚ РїСЂРёС‡РёРЅСѓ РѕС‚РєР»РѕРЅРµРЅРёСЏ.

### РЎРѕСЃС‚РѕСЏРЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІР° (`gh/dev/<DEVICE_ID>/state`, retained)
Retained-СЃРѕРѕР±С‰РµРЅРёРµ РѕРїРёСЃС‹РІР°РµС‚ С‚РµРЅРµРІР°СЏ СЃРѕСЃС‚РѕСЏРЅРёРµ (Device Shadow) СЂСѓС‡РЅРѕРіРѕ СЂРµР¶РёРјР°:

```json
{
  "manual_watering": {
    "status": "running",
    "duration_s": 20,
    "started_at": "1970-01-01T00:00:00Z",
    "correlation_id": "abc123"
  },
  "fw": "esp32-alpha1"
}
```

```json
{
  "manual_watering": {
    "status": "idle",
    "duration_s": null,
    "started_at": null,
    "correlation_id": null
  },
  "fw": "esp32-alpha1"
}
```

- РЎРѕРѕР±С‰РµРЅРёРµ СЃРѕС…СЂР°РЅСЏРµС‚СЃСЏ Р±СЂРѕРєРµСЂРѕРј (retain) Рё РЅРµРјРµРґР»РµРЅРЅРѕ РІС‹РґР°С‘С‚СЃСЏ РїСЂРё РїРѕРґРїРёСЃРєРµ, РїРѕСЌС‚РѕРјСѓ СЃРµСЂРІРµСЂ РѕРїСЂРµРґРµР»СЏРµС‚ РѕРЅР»Р°Р№РЅ/РѕС„Р»Р°Р№РЅ СЃРѕСЃС‚РѕСЏРЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІР°, СЃРѕСЃС‚РѕСЏРЅРёРµ РЅР°СЃРѕСЃР° Рё Р°РєС‚РёРІРЅС‹Р№ СЃРµР°РЅСЃ РїРѕР»РёРІР°.
- `started_at` РїРѕРєР° Р·Р°РїРѕР»РЅСЏРµС‚СЃСЏ Р·Р°РіР»СѓС€РєРѕР№ (РЅРµС‚ RTC/NTP); РІ Р±СѓРґСѓС‰РёС… РІРµСЂСЃРёСЏС… Р±СѓРґРµС‚ СЂРµР°Р»СЊРЅРѕРµ Р·РЅР°С‡РµРЅРёРµ РІ UTC.

## РџРѕРІРµРґРµРЅРёРµ СѓСЃС‚СЂРѕР№СЃС‚РІР°
1. **РЎС‚Р°СЂС‚:** ESP32 РїРѕРґРєР»СЋС‡Р°РµС‚СЃСЏ Рє Wi-Fi, Р·Р°С‚РµРј Рє MQTT, РїСѓР±Р»РёРєСѓРµС‚ retained `state` СЃ `status="idle"`.
2. **РљРѕРјР°РЅРґР° `pump.start`:** РІРєР»СЋС‡Р°РµС‚ РЅР°СЃРѕСЃ (`app.setManualPumpState(true)`), СЃРѕС…СЂР°РЅСЏРµС‚ Р»РѕРєР°Р»СЊРЅС‹Рµ С„Р»Р°РіРё (`g_isWatering`, `g_wateringDurationSec`, `g_activeCorrelationId`), РїСѓР±Р»РёРєСѓРµС‚ ACK Рё РѕР±РЅРѕРІР»С‘РЅРЅС‹Р№ `state` СЃРѕ `status="running"`.
3. **РљРѕРјР°РЅРґР° `pump.stop`:** РІС‹РєР»СЋС‡Р°РµС‚ РЅР°СЃРѕСЃ, РїСѓР±Р»РёРєСѓРµС‚ ACK Рё `state` СЃРѕ `status="idle"`.
4. **РђРІС‚РѕРѕСЃС‚Р°РЅРѕРІРєР° РїРѕ С‚Р°Р№РјРµСЂСѓ:** РїРѕ РёСЃС‚РµС‡РµРЅРёРё `duration_s` РЅР°СЃРѕСЃ РѕС‚РєР»СЋС‡Р°РµС‚СЃСЏ Р°РІС‚РѕРјР°С‚РёС‡РµСЃРєРё, РїСѓР±Р»РёРєСѓРµС‚СЃСЏ `state` СЃРѕ `status="idle"`.
5. **Р РµРєРѕРЅРЅРµРєС‚ MQTT:** РїСЂРё РІРѕСЃСЃС‚Р°РЅРѕРІР»РµРЅРёРё СЃРѕРµРґРёРЅРµРЅРёСЏ СѓСЃС‚СЂРѕР№СЃС‚РІРѕ РїРѕРІС‚РѕСЂРЅРѕ РїСѓР±Р»РёРєСѓРµС‚ retained `state`, С‡С‚РѕР±С‹ СЃРµСЂРІРµСЂ РІРёРґРµР», С‡С‚Рѕ РєРѕРЅС‚СЂРѕР»Р»РµСЂ СЃРЅРѕРІР° РѕРЅР»Р°Р№РЅ.

## РџСЂРёРјРµС‡Р°РЅРёСЏ
- QoS=1 РІС‹Р±СЂР°РЅ РґР»СЏ РЅР°РґС‘Р¶РЅРѕР№ РґРѕСЃС‚Р°РІРєРё Р±РµР· СЃР»РѕР¶РЅРѕРіРѕ РґРµРґСѓРїР»РёСЂРѕРІР°РЅРёСЏ.
- Retain=true РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ С‚РѕР»СЊРєРѕ РґР»СЏ С‚РѕРїРёРєР° `state`; РІСЃРµ ACK Рё РєРѕРјР°РЅРґС‹ РѕС‚РїСЂР°РІР»СЏСЋС‚СЃСЏ Р±РµР· retain.
- РЎРµСЂРІРµСЂ РїСЂРёРјРµРЅСЏРµС‚ HTTP-СЌРЅРґРїРѕРёРЅС‚ РѕР¶РёРґР°РЅРёСЏ (`/api/manual-watering/wait-ack`) РґР»СЏ СЃРёРЅС…СЂРѕРЅРёР·Р°С†РёРё СЃ ACK.
- UI `/static/manual_watering.html` РѕС‚РѕР±СЂР°Р¶Р°РµС‚ РїСЂРѕРіСЂРµСЃСЃ РїРѕ РґР°РЅРЅС‹Рј ACK Рё С‚РµРєСѓС‰РµРјСѓ `state`.

## Р‘СѓРґСѓС‰РёРµ СЂР°СЃС€РёСЂРµРЅРёСЏ (TODO)
- РЎРёРЅС…СЂРѕРЅРёР·Р°С†РёСЏ РІСЂРµРјРµРЅРё С‡РµСЂРµР· NTP РґР»СЏ РєРѕСЂСЂРµРєС‚РЅРѕРіРѕ Р·Р°РїРѕР»РЅРµРЅРёСЏ `started_at`.
- РџРµСЂРёРѕРґРёС‡РµСЃРєР°СЏ (heartbeat) РїСѓР±Р»РёРєР°С†РёСЏ `state`, РґР°Р¶Рµ Р±РµР· РєРѕРјР°РЅРґ.
- РџРѕРґРґРµСЂР¶РєР° РѕР±РЅРѕРІР»РµРЅРёСЏ РїСЂРѕС€РёРІРєРё РїРѕ MQTT.
- Р Р°СЃС€РёСЂРµРЅРёРµ РїСЂРѕС‚РѕРєРѕР»Р° РґРѕРїРѕР»РЅРёС‚РµР»СЊРЅС‹РјРё С‚РёРїР°РјРё РєРѕРјР°РЅРґ (РґР°С‚С‡РёРєРё, РѕСЃРІРµС‰РµРЅРёРµ Рё С‚.Рї.).
