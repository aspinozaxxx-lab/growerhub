﻿﻿<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Личный кабинет</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1100px;
            margin: 20px auto;
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1, h2 {
            margin-top: 0;
            color: #2c3e50;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }
        input, button {
            padding: 8px;
            margin-top: 6px;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            cursor: pointer;
            background: #27ae60;
            color: #fff;
            border: none;
        }
        button.secondary {
            background: #2980b9;
        }
        button.danger {
            background: #c0392b;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f0f0f0;
        }
        .error { color: #c0392b; margin-top: 8px; }
        .success { color: #27ae60; margin-top: 8px; }
        .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    </style>
</head>
<body>
<div class="container">
    <div class="actions" style="justify-content: space-between;">
        <h1 style="margin: 0;">Личный кабинет</h1>
        <div class="actions">
            <a href="/static/index.html" style="text-decoration:none;"><button class="secondary" type="button">Главная</button></a>
            <button id="btn-admin" class="secondary" type="button" style="display:none;">Администрирование</button>
            <button id="logoutBtn" class="danger" type="button">Выйти</button>
        </div>
    </div>

    <div id="userInfo" style="margin: 10px 0; color: #555;"></div>

    <div class="grid">
        <div>
            <h2>Профиль</h2>
            <form id="profileForm">
                <label for="email">Email</label>
                <input id="email" type="email" required>

                <label for="username">Имя пользователя</label>
                <input id="username" type="text">

                <button type="submit">Сохранить профиль</button>
                <div id="profileMessage" class="error"></div>
            </form>
        </div>
        <div>
            <h2>Смена пароля</h2>
            <form id="passwordForm">
                <label for="currentPassword">Текущий пароль</label>
                <input id="currentPassword" type="password" required>

                <label for="newPassword">Новый пароль</label>
                <input id="newPassword" type="password" required>

                <label for="confirmPassword">Подтверждение</label>
                <input id="confirmPassword" type="password" required>

                <button type="submit">Обновить пароль</button>
                <div id="passwordMessage" class="error"></div>
            </form>
        </div>
        <div>
            <h2>Способы входа</h2>
            <div id="methodsStatus" class="error"></div>
            <div id="methodsList" style="margin: 8px 0; color: #555;"></div>
            <button type="button" id="btnToggleLocal">Добавить/изменить вход по почте</button>
            <form id="localMethodForm" style="display:none; margin-top: 10px;">
                <label for="localEmail">Email для входа</label>
                <input id="localEmail" type="email" required>
                <label for="localPassword">Пароль</label>
                <input id="localPassword" type="password" required>
                <button type="submit">Сохранить способ</button>
                <div id="localMethodMessage" class="error"></div>
            </form>
            <div class="actions" style="margin-top: 12px;">
                <button type="button" class="secondary" id="btnLinkGoogle">Привязать Google</button>
                <button type="button" class="secondary" id="btnLinkYandex">Привязать Yandex</button>
            </div>
            <div class="actions" style="margin-top: 8px;">
                <button type="button" class="danger" id="btnUnlinkGoogle" style="display:none;">Удалить Google</button>
                <button type="button" class="danger" id="btnUnlinkYandex" style="display:none;">Удалить Yandex</button>
            </div>
        </div>
    </div>

    <h2>Мои растения</h2>
    <div id="plantsMessage" class="error"></div>
    <table id="plantsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Название</th>
                <th>Группа</th>
                <th>Дата посадки</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h2>Мои устройства</h2>
    <div id="devicesMessage" class="error"></div>
    <table id="devicesTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Device ID</th>
                <th>Название</th>
                <th>Статус</th>
                <th>Привязано к (ID растений)</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3>Добавить устройство по ID</h3>
    <form id="assignForm" class="actions">
        <input id="assignDeviceId" type="number" placeholder="ID устройства" required style="max-width: 200px;">
        <button type="submit">Добавить</button>
        <div id="assignMessage" class="error"></div>
    </form>
</div>

<script>
    const TOKEN_KEY = 'gh_access_token';
    let accessToken = localStorage.getItem(TOKEN_KEY);

    const applyTokenFromHash = () => {
        const hash = window.location.hash || '';
        if (!hash) return;
        const params = new URLSearchParams(hash.replace(/^#/, ''));
        const token = params.get('access_token');
        const type = params.get('token_type');
        const isBearer = !type || String(type).toLowerCase() === 'bearer';
        if (token && isBearer) {
            accessToken = token;
            localStorage.setItem(TOKEN_KEY, token);
            window.location.hash = '';
        }
    };

    applyTokenFromHash();

    if (!accessToken) {
        window.location.href = '/static/login.html';
    }

    const redirectToLogin = () => {
        localStorage.removeItem(TOKEN_KEY);
        accessToken = null;
        window.location.href = '/static/login.html';
    };

    const authFetch = async (url, options = {}) => {
        const token = accessToken || localStorage.getItem(TOKEN_KEY);
        const opts = { ...options };
        opts.headers = { ...(options.headers || {}), ...(token ? { Authorization: `Bearer ${token}` } : {}) };
        const response = await fetch(url, opts);
        if (response.status === 401 || response.status === 403) {
            redirectToLogin();
        }
        return response;
    };

    const userInfo = document.getElementById('userInfo');
    const profileForm = document.getElementById('profileForm');
    const profileMessage = document.getElementById('profileMessage');
    const passwordForm = document.getElementById('passwordForm');
    const passwordMessage = document.getElementById('passwordMessage');
    const devicesTableBody = document.querySelector('#devicesTable tbody');
    const devicesMessage = document.getElementById('devicesMessage');
    const assignForm = document.getElementById('assignForm');
    const assignDeviceId = document.getElementById('assignDeviceId');
    const assignMessage = document.getElementById('assignMessage');
    const btnAdmin = document.getElementById('btn-admin');
    const methodsStatus = document.getElementById('methodsStatus');
    const methodsList = document.getElementById('methodsList');
    const btnToggleLocal = document.getElementById('btnToggleLocal');
    const localMethodForm = document.getElementById('localMethodForm');
    const localEmail = document.getElementById('localEmail');
    const localPassword = document.getElementById('localPassword');
    const localMethodMessage = document.getElementById('localMethodMessage');
    const btnLinkGoogle = document.getElementById('btnLinkGoogle');
    const btnLinkYandex = document.getElementById('btnLinkYandex');
    const btnUnlinkGoogle = document.getElementById('btnUnlinkGoogle');
    const btnUnlinkYandex = document.getElementById('btnUnlinkYandex');
    const plantsTableBody = document.querySelector('#plantsTable tbody');
    const plantsMessage = document.getElementById('plantsMessage');

    document.getElementById('logoutBtn').addEventListener('click', redirectToLogin);
    btnAdmin.addEventListener('click', function () {
        window.location.href = '/static/admin_devices.html';
    });

    let currentUser = null;
    let userPlants = [];
    let userDevices = [];

    async function loadProfile() {
        const resp = await authFetch('/api/auth/me');
        if (!resp.ok) return redirectToLogin();
        currentUser = await resp.json();
        userInfo.textContent = `${currentUser.email} • роль: ${currentUser.role}`;
        document.getElementById('email').value = currentUser.email || '';
        document.getElementById('username').value = currentUser.username || '';
        if (currentUser.role === "admin") {
            btnAdmin.style.display = "inline-block";
        }
    }

    function renderPlantsList(plants) {
        plantsTableBody.innerHTML = '';
        plantsMessage.textContent = '';
        if (!plants.length) {
            plantsTableBody.innerHTML = '<tr><td colspan="4">Нет добавленных растений</td></tr>';
            return;
        }
        plants.forEach((plant) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${plant.id}</td>
                <td>${plant.name}</td>
                <td>${plant.plant_group ? plant.plant_group.name : ''}</td>
                <td>${new Date(plant.planted_at).toLocaleDateString()}</td>
            `;
            plantsTableBody.appendChild(tr);
        });
    }

    async function loadPlants() {
        const resp = await authFetch('/api/plants');
        plantsTableBody.innerHTML = '';
        plantsMessage.textContent = '';
        if (!resp.ok) {
            plantsMessage.textContent = 'Не удалось загрузить растения';
            return;
        }
        userPlants = await resp.json();
        renderPlantsList(userPlants);
    }

    async function loadDevices() {
        const resp = await authFetch('/api/devices/my');
        devicesTableBody.innerHTML = '';
        devicesMessage.textContent = '';
        if (!resp.ok) {
            devicesMessage.textContent = 'Не удалось загрузить устройства';
            return;
        }
        userDevices = await resp.json();
        renderDevices();
    }

    function renderPlantCell(cell, device) {
        const plantIdsText = device.plant_ids && device.plant_ids.length ? device.plant_ids.join(', ') : '—';
        cell.dataset.mode = 'view';
        cell.innerHTML = `
            <span class="plant-ids" title="Формат: ID rastenij cherez zapjatuju, naprimer: 1,2,5">${plantIdsText}</span>
            <button type="button" class="secondary" data-action="edit-plants">Ред.</button>
        `;
    }

    function renderDevices() {
        devicesTableBody.innerHTML = '';
        if (!Array.isArray(userDevices) || userDevices.length === 0) {
            devicesTableBody.innerHTML = '<tr><td colspan="6">Нет привязанных устройств</td></tr>';
            return;
        }

        userDevices.forEach((device) => {
            const tr = document.createElement('tr');
            tr.dataset.deviceId = device.id;
            const status = device.is_online ? 'В сети' : 'Не в сети';

            const plantCell = document.createElement('td');
            renderPlantCell(plantCell, device);

            tr.innerHTML = `
                <td>${device.id}</td>
                <td>${device.device_id}</td>
                <td>${device.name || ''}</td>
                <td>${status}</td>
                <td></td>
                <td><button type="button" data-action="unassign">Отвязать</button></td>
            `;

            tr.children[4].replaceWith(plantCell);
            devicesTableBody.appendChild(tr);
        });
    }

    function getDeviceById(deviceId) {
        return userDevices.find((item) => item.id === deviceId);
    }

    function enterEditMode(plantCell, device) {
        const currentValue = device.plant_ids && device.plant_ids.length ? device.plant_ids.join(', ') : '';
        plantCell.dataset.mode = 'edit';
        plantCell.innerHTML = `
            <input type="text" value="${currentValue}" placeholder="1,2,5" title="Формат: ID rastenij cherez zapjatuju, naprimer: 1,2,5">
            <div class="actions">
                <button type="button" data-action="save-plants">Сохранить</button>
                <button type="button" class="secondary" data-action="cancel-plants">Отмена</button>
            </div>
        `;
    }

    function parsePlantIds(value) {
        if (!value.trim()) return [];
        const parts = value.split(',').map((item) => item.trim()).filter(Boolean);
        const ids = parts.map((item) => Number(item));
        if (ids.some((id) => Number.isNaN(id) || !Number.isInteger(id))) {
            throw new Error('ID dolzhny byt celami chislamy');
        }
        const unique = [];
        ids.forEach((id) => {
            if (!unique.includes(id)) {
                unique.push(id);
            }
        });
        return unique;
    }

    function validatePlantIds(ids) {
        if (!ids.length) return true;
        if (!userPlants.length) {
            return false;
        }
        const known = new Set(userPlants.map((plant) => plant.id));
        return ids.every((id) => known.has(id));
    }

    devicesTableBody.addEventListener('click', async (event) => {
        const action = event.target.dataset.action;
        if (!action) return;
        const tr = event.target.closest('tr');
        if (!tr) return;
        const deviceId = Number(tr.dataset.deviceId);
        const device = getDeviceById(deviceId);
        if (!device) return;

        if (action === 'unassign') {
            assignMessage.textContent = '';
            const resp = await authFetch(`/api/devices/${deviceId}/unassign`, { method: 'POST' });
            if (!resp.ok) {
                const data = await resp.json().catch(() => ({}));
                assignMessage.textContent = data.detail || 'Не удалось отвязать устройство';
                return;
            }
            await loadDevices();
            return;
        }

        const plantCell = tr.children[4];
        if (action === 'edit-plants') {
            enterEditMode(plantCell, device);
            return;
        }
        if (action === 'cancel-plants') {
            renderPlantCell(plantCell, device);
            return;
        }
        if (action === 'save-plants') {
            const input = plantCell.querySelector('input');
            const value = input ? input.value : '';
            let newIds = [];
            try {
                newIds = parsePlantIds(value);
            } catch (error) {
                alert(error.message || 'Некорректные ID растений');
                return;
            }
            if (!validatePlantIds(newIds)) {
                alert('Указаны несуществующие ID растений. Проверьте список в таблице выше.');
                return;
            }

            const oldIds = Array.isArray(device.plant_ids) ? device.plant_ids : [];
            const toAdd = newIds.filter((id) => !oldIds.includes(id));
            const toRemove = oldIds.filter((id) => !newIds.includes(id));

            try {
                for (const plantId of toAdd) {
                    const resp = await authFetch(`/api/plants/${plantId}/devices/${deviceId}`, { method: 'POST' });
                    if (!resp.ok) {
                        throw new Error('attach-failed');
                    }
                }
                for (const plantId of toRemove) {
                    const resp = await authFetch(`/api/plants/${plantId}/devices/${deviceId}`, { method: 'DELETE' });
                    if (!resp.ok) {
                        throw new Error('detach-failed');
                    }
                }
            } catch (error) {
                alert('Не удалось обновить привязки устройств к растениям');
                renderPlantCell(plantCell, device);
                return;
            }

            device.plant_ids = newIds;
            renderPlantCell(plantCell, device);
        }
    });

    function renderMethods(data) {
        methodsStatus.textContent = '';
        localMethodMessage.textContent = '';
        methodsList.innerHTML = `
            <p>Локальный вход: ${data.local.active ? 'настроен' : 'не настроен'} (${data.local.email || ''})</p>
            <p>Google: ${data.google.linked ? 'привязан' : 'не привязан'}</p>
            <p>Yandex: ${data.yandex.linked ? 'привязан' : 'не привязан'}</p>
        `;
        btnToggleLocal.textContent = data.local.active ? 'Изменить вход по почте' : 'Добавить вход по почте';
        btnUnlinkGoogle.style.display = data.google.linked && data.google.can_delete ? 'inline-block' : 'none';
        btnUnlinkYandex.style.display = data.yandex.linked && data.yandex.can_delete ? 'inline-block' : 'none';
        btnLinkGoogle.disabled = data.google.linked;
        btnLinkYandex.disabled = data.yandex.linked;
        localEmail.value = data.local.email || '';
    }

    async function loadMethods() {
        const resp = await authFetch('/api/auth/methods');
        if (!resp.ok) {
            methodsStatus.textContent = 'Не удалось загрузить способы входа';
            return;
        }
        const data = await resp.json();
        renderMethods(data);
    }

    async function startLink(provider) {
        methodsStatus.textContent = '';
        try {
            const resp = await authFetch(`/api/auth/sso/${provider}/login`, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
            });
            if (!resp.ok) {
                throw new Error(`HTTP ${resp.status}`);
            }
            const data = await resp.json();
            if (!data.url) {
                throw new Error('No url in response');
            }
            window.location.href = data.url;
        } catch (error) {
            console.error('Failed to start link', error);
            methodsStatus.textContent = 'Не удалось начать привязку';
        }
    }

    async function deleteMethod(provider) {
        methodsStatus.textContent = '';
        const resp = await authFetch(`/api/auth/methods/${provider}`, { method: 'DELETE' });
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            methodsStatus.textContent = data.detail || 'Не удалось удалить способ входа';
            return;
        }
        const data = await resp.json();
        renderMethods(data);
    }

    profileForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        profileMessage.textContent = '';
        const payload = {
            email: document.getElementById('email').value.trim(),
            username: document.getElementById('username').value.trim(),
        };
        const resp = await authFetch('/api/auth/me', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            profileMessage.textContent = data.detail || 'Ошибка обновления профиля';
            return;
        }
        profileMessage.textContent = '';
        await loadProfile();
    });

    passwordForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        passwordMessage.textContent = '';
        passwordMessage.className = 'error';
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirm = document.getElementById('confirmPassword').value;
        if (newPassword !== confirm) {
            passwordMessage.textContent = 'Новый пароль не совпадает с подтверждением';
            return;
        }
        const resp = await authFetch('/api/auth/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ current_password: currentPassword, new_password: newPassword }),
        });
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            passwordMessage.textContent = data.detail || 'Ошибка смены пароля';
            return;
        }
        passwordMessage.textContent = 'Пароль обновлен';
        passwordMessage.className = 'success';
        passwordForm.reset();
    });

    btnToggleLocal.addEventListener('click', () => {
        localMethodMessage.textContent = '';
        localMethodForm.style.display = localMethodForm.style.display === 'none' ? 'block' : 'none';
    });

    localMethodForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        localMethodMessage.textContent = '';
        const email = localEmail.value.trim();
        const password = localPassword.value;
        const resp = await authFetch('/api/auth/methods/local', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password }),
        });
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            localMethodMessage.textContent = data.detail || 'Не удалось сохранить способ';
            return;
        }
        const data = await resp.json();
        renderMethods(data);
        localPassword.value = '';
        localMethodForm.style.display = 'none';
    });

    btnLinkGoogle.addEventListener('click', () => startLink('google'));
    btnLinkYandex.addEventListener('click', () => startLink('yandex'));
    btnUnlinkGoogle.addEventListener('click', () => deleteMethod('google'));
    btnUnlinkYandex.addEventListener('click', () => deleteMethod('yandex'));

    assignForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        assignMessage.textContent = '';
        const deviceId = Number(assignDeviceId.value);
        const resp = await authFetch('/api/devices/assign-to-me', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_id: deviceId }),
        });
        if (!resp.ok) {
            const data = await resp.json().catch(() => ({}));
            assignMessage.textContent = data.detail || 'Не удалось привязать устройство';
            return;
        }
        assignForm.reset();
        await loadDevices();
    });

    async function init() {
        await loadProfile();
        await loadPlants();
        await loadDevices();
        await loadMethods();
    }

    init();
</script>
</body>
</html>

