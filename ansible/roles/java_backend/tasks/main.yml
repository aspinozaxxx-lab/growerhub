---
- name: Check docker CLI is available
  become: true
  ansible.builtin.command: docker --version
  register: java_backend_docker_cli
  changed_when: false
  failed_when: false

- name: Fail if docker CLI is unavailable
  ansible.builtin.fail:
    msg: >-
      Docker is required on the target host for the java_backend role.
      Install Docker Engine and ensure the `docker` command is available in PATH.
  when: java_backend_docker_cli.rc != 0

- name: Check docker daemon is available
  become: true
  ansible.builtin.command: docker info
  register: java_backend_docker_info
  changed_when: false
  failed_when: false

- name: Fail if docker daemon is unavailable
  ansible.builtin.fail:
    msg: >-
      Docker daemon is not available (docker info failed).
      Ensure Docker Engine is running (e.g. `systemctl status docker`) and the current user can access the Docker socket.
  when: java_backend_docker_info.rc != 0

- name: Check python docker SDK is available (python3-docker)
  become: true
  ansible.builtin.command: python3 -c "import docker; print(docker.__version__)"
  register: java_backend_python_docker
  changed_when: false
  failed_when: false

- name: Fail if python docker SDK is missing
  ansible.builtin.fail:
    msg: >-
      Python Docker SDK is required for community.docker modules used by this role.
      Install `python3-docker` on the target host.
  when: java_backend_python_docker.rc != 0

- name: Ensure deployment directory exists
  become: true
  ansible.builtin.file:
    path: "{{ java_backend_deploy_dir }}"
    state: directory
    owner: "{{ ansible_user | default(ansible_ssh_user) | default(ansible_facts.user_id) | default('root') }}"
    group: "{{ ansible_user | default(ansible_ssh_user) | default(ansible_facts.user_id) | default('root') }}"
    mode: "0755"

- name: Assert required env values are set
  ansible.builtin.assert:
    that:
      - java_backend_secret_key | default("") | length > 0
      - java_backend_db_url | default("") | length > 0
      - java_backend_db_username | default("") | length > 0
      - java_backend_db_password | default("") | length > 0
    fail_msg: >-
      Ne zadany obyazatelnye peremennye dlya env-file java backend.
      Nuzhno ukazat' java_backend_secret_key, java_backend_db_url,
      java_backend_db_username, java_backend_db_password v vars/vault.

- name: Assert MQTT vars when MQTT is enabled
  ansible.builtin.assert:
    that:
      - java_backend_mqtt_port is defined
      - (java_backend_mqtt_port | int) > 0
      - (java_backend_mqtt_username | default("") | length == 0 and java_backend_mqtt_password | default("") | length == 0)
        or (java_backend_mqtt_username | default("") | length > 0 and java_backend_mqtt_password | default("") | length > 0)
    fail_msg: >-
      MQTT vklyuchen (java_backend_mqtt_host zadany), no ne vse peremennye est'.
      Nuzhno ukazat' java_backend_mqtt_port, a takzhe oba java_backend_mqtt_username i java_backend_mqtt_password,
      esli ispol'zuetsya autentifikaciya.
  when: java_backend_mqtt_host | default("") | length > 0

- name: Ensure env directory exists
  become: true
  ansible.builtin.file:
    path: "{{ java_backend_env_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Render env file for java backend
  become: true
  ansible.builtin.copy:
    dest: "{{ java_backend_env_file }}"
    owner: root
    group: root
    mode: "0600"
    content: |-
      {% for item in java_backend_env | dict2items %}
      {{ item.key }}={{ item.value }}
      {% endfor %}

- name: Sync backend sources to target (rsync)
  become: false
  ansible.posix.synchronize:
    mode: push
    src: "{{ java_backend_local_src_dir }}/"
    dest: "{{ java_backend_deploy_dir }}/"
    delete: true
    rsync_opts: "{{ java_backend_rsync_opts }}"
  register: java_backend_sync

- name: Build docker image on target (when sources changed)
  become: true
  ansible.builtin.command: "docker build -t {{ java_backend_image }} ."
  args:
    chdir: "{{ java_backend_deploy_dir }}"
  register: java_backend_build
  changed_when: true
  when: java_backend_force_build or java_backend_sync.changed

- name: Ensure java backend container is running
  become: true
  community.docker.docker_container:
    name: "{{ java_backend_container_name }}"
    image: "{{ java_backend_image }}"
    restart_policy: always
    env_file:
      - "{{ java_backend_env_file }}"
    published_ports:
      - "{{ java_backend_bind_ip }}:{{ java_backend_host_port }}:{{ java_backend_container_port }}"
    state: started
    recreate: "{{ java_backend_build.changed | default(false) }}"

- name: Check java backend container status
  become: true
  community.docker.docker_container_info:
    name: "{{ java_backend_container_name }}"
  register: java_backend_container_info

- name: Fail if java backend container is not running
  ansible.builtin.fail:
    msg: "Container {{ java_backend_container_name }} is not running. Check `docker logs {{ java_backend_container_name }}`."
  when: not (java_backend_container_info.exists and java_backend_container_info.container.State.Running | default(false))
