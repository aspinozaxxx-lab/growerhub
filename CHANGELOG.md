# Changelog

## [2025-10-24] MQTT step 1

- Добавлена начальная интеграция Wi-Fi и MQTT в прошивку ESP32: контроллер подключается к сети как STA, авторизуется в Mosquitto с логином `mosquitto-admin` и clientId `ESP32_2C294C`.
- Устройство подписывается на командный топик `gh/dev/ESP32_2C294C/cmd` (QoS=1) и выводит входящие команды в Serial с топиком, полезной нагрузкой и длиной сообщения для отладки.
- Реализован автоматический реконнект к брокеру с интервалом 5 секунд и повторной подпиской после переподключения, чтобы устройство уверенно переживало обрывы связи.
- В следующих шагах добавим обработку pump.start/pump.stop, публикацию ACK и state — сейчас они сознательно отключены.

� �⮬ 䠩�� 䨪������� ��������� �஥��. �ᯮ��㥬 �ଠ� Keep a Changelog � Semantic Versioning.

## [2025-10-24]

### ���������
  - �������� ��⠫�� �⫠���� �뢮� ������稪�� MQTT �१ print(), ����� ����砥�: ���/���� � ��� ���짮��⥫� �� ����⪥ ������祭��, rc � on_connect, 䠪� �����᪨ �� gh/dev/+/state � gh/dev/+/ack, �室�騥 ���� MQTT-ᮮ�饭��, �訡�� ���ᨭ�� (�᫨ �ଠ� �� ᮢ���), ���������� ���.
  - �������� �⫠���� �������� GET /_debug/manual-watering/config (⮫쪮 �� DEBUG=True), �⮡� ����� �஢���� ����� MQTT-����ன�� ॠ�쭮 �ᯮ���� ����饭�� �����.
- ��������� �஢�ન ���ﭨ� DeviceShadowStore ��। start/stop � API ��筮�� ������ (409 �� ����୮� �����).
- �������� �������� GET /api/manual-watering/wait-ack ��� ���� �������� ���⢥ত���� ������.
- ��������� ���� is_online � last_seen_at � GET /api/manual-watering/status.
- ���� offline_reason ������ ��稭� �����஢�� ������ (device_offline/no_state_yet/None).
- ��������� ���㬥���� docs/manual_watering_protocol.md � ���ᠭ��� ��⮪���.
- ��������� ���஡��� ����஢���� MQTT-������稪�� (state � ack): ������祭��, �室�騥 ᮮ�饭��, �訡�� ���ᨭ��.
- �������� �⫠���� �������� GET /_debug/manual-watering/snapshot (⮫쪮 �� DEBUG=True) ��� ��ᬮ�� ����� ������ ���ன�⢠ � ����� �ࢥ�.

### ��������
- ��७�� manual_watering.html �� server/static � static/.
- ������� ����䥩� ��筮�� ������: �����প� is_online � last_seen_at, �ᯮ�짮����� wait-ack ����� ��⮣� ����,
  �����஢�� ������ �� ��䫠���, ���襭�� �ண���-��� � 㢥��������.
- ��࠭�� manual_watering.html �ࠧ� ��᫥ ����� device_id ����訢��� �����, ��⨢���� ������ ⮫쪮 ��� ������-���ன��
  � ������ �業�ਨ ������/��䫠��/���ன�⢮ �� ������� ��אַ � UI.
- ����� 䫠� DEBUG � ����ன���; �ࢨ�� �⫠���� ��窨 ����㯭� ⮫쪮 �� DEBUG=True.
- GET /api/manual-watering/status ⥯��� �⤠�� 200 c �����誮�, ���� �᫨ state ��� �� ��室�� - �஭⥭� �������� ������ �����⭮.
- ������稪� MQTT (MqttStateSubscriber, MqttAckSubscriber) � MQTT-�㡫����� ⥯��� �ᯮ����� �����/��஫� �� ����஥� �� ������祭�� � �ப���.
- � ����� ������祭�� ⥯��� 䨪��㥬 rc � ���� �ப��, �� ��頥� ���� �⪠��� ���ਧ�樨 (rc=5 = Not authorized).

### ��ࠢ����
- ���࠭��� �஡���� � ����⮬ remaining_s � ᨭ�஭���樥� ACK � ����.
- ����� ��������� � ���⮬ ०��� DEBUG.

### ����
- ������� �������⨪�, ��祬� UI ����� "��� ������ ?", � 㡥������, �� �ࢥ� ����⢨⥫쭮 ����砥� state � ����砥� ���ன�⢮ ��� "������ ?".

## [2025-10-23]

### ���������
- ��砫쭠� ����ன�� ��訢�� � �ᯮ����⥫��� �ਯ⮢ (firmware/config.ini, scripts/post_upload.py � ��.).

### ��������
- ����஥�� ࠡ�� ��訢�� � EEPROM � ��⥣��� � SPIFFS.

### ��ࠢ����
- ����४�஢��� API Wi-Fi � OTA ��� �����প� ����� �業�ਥ� ��訢��.
