name: CI/CD Backend (Java)

on:
  pull_request:
    paths:
      - "backend/**"
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
  workflow_dispatch:

jobs:
  ci:
    name: CI (java backend)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle (with cache)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.10.2"

      - name: Gradle test
        working-directory: backend
        run: gradle --no-daemon test

      - name: Gradle build
        working-directory: backend
        run: gradle --no-daemon build -x test

      - name: Docker build
        working-directory: backend
        run: docker build -t growerhub-backend:ci .

  deploy:
    name: Deploy to production (java backend)
    runs-on: ubuntu-latest
    needs: [ ci ]
    if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read
    environment:
      name: production
      url: https://growerhub.ru/health
    env:
      SSH_HOST: growerhub.ru
      SSH_PORT: "6733"
      SSH_USER: watering-admin
      DEPLOY_DIR: /opt/growerhub/java-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate deploy configuration
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${SSH_HOST:-}" ]; then
            echo "SSH_HOST is empty." >&2
            exit 1
          fi
          if [ -z "${SSH_USER:-}" ]; then
            echo "SSH_USER is empty." >&2
            exit 1
          fi
          echo "SSH_HOST=$SSH_HOST"
          echo "SSH_USER=$SSH_USER"
          echo "SSH_PORT=$SSH_PORT"

      - name: Setup SSH
        run: |
          install -m 700 -d ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: SSH smoke test
        run: |
          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=yes "$SSH_USER@$SSH_HOST" "echo 'SSH OK'"

      - name: Check deploy dir is writable
        shell: bash
        run: |
          set -euo pipefail
          if ! ssh -p "$SSH_PORT" -o StrictHostKeyChecking=yes "$SSH_USER@$SSH_HOST" "test -w \"$DEPLOY_DIR\""; then
            echo "No write access to $DEPLOY_DIR on $SSH_HOST for user $SSH_USER. Create it and grant write permissions, then re-run deploy." >&2
            exit 1
          fi

      - name: Sync backend to server
        run: |
          rsync -azv --delete \
            --exclude ".gradle/" --exclude "build/" --exclude ".idea/" --exclude "out/" \
            --omit-dir-times --no-perms --no-owner --no-group \
            -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=yes" \
            ./backend/ "$SSH_USER@$SSH_HOST:$DEPLOY_DIR/"

      - name: Remote build + restart container
        run: |
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" <<'EOF'
          set -e
          docker build -t growerhub-backend:local /opt/growerhub/java-backend
          docker rm -f growerhub-java-backend || true
          docker run -d --name growerhub-java-backend --restart unless-stopped -p 127.0.0.1:18080:8080 growerhub-backend:local
          docker ps --filter name=growerhub-java-backend

          ok=0
          for i in $(seq 1 30); do
            if curl -fsS http://127.0.0.1:18080/health >/tmp/health.json 2>/tmp/health.err; then
              ok=1
              cat /tmp/health.json
              break
            fi
            echo "healthcheck attempt $i failed: $(cat /tmp/health.err 2>/dev/null || true)"
            sleep 1
          done

          if [ "$ok" -ne 1 ]; then
            docker ps --filter name=growerhub-java-backend
            docker logs --tail=200 growerhub-java-backend || true
            exit 1
          fi
          EOF
