name: CI/CD Backend (Java)

on:
  pull_request:
    paths:
      - "backend/**"
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"

jobs:
  ci:
    name: CI (java backend)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Ensure Gradle wrapper is executable
        run: chmod +x backend/gradlew

      - name: Gradle test
        working-directory: backend
        run: ./gradlew --no-daemon test

      - name: Gradle build
        working-directory: backend
        run: ./gradlew --no-daemon build -x test

      - name: Docker build
        working-directory: backend
        run: docker build -t growerhub-backend:ci .

  deploy:
    name: Deploy to production (java backend)
    runs-on: ubuntu-latest
    needs: [ ci ]
    if: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read
    environment:
      name: production
      url: https://growerhub.ru/health
    env:
      SSH_HOST: growerhub.ru
      SSH_PORT: "6733"
      SSH_USER: watering-admin
      DEPLOY_DIR: /opt/growerhub/java-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate deploy configuration
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${SSH_HOST:-}" ]; then
            echo "SSH_HOST is empty." >&2
            exit 1
          fi
          if [ -z "${SSH_USER:-}" ]; then
            echo "SSH_USER is empty." >&2
            exit 1
          fi
          echo "SSH_HOST=$SSH_HOST"
          echo "SSH_USER=$SSH_USER"
          echo "SSH_PORT=$SSH_PORT"

      - name: Setup SSH
        run: |
          install -m 700 -d ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: SSH smoke test
        run: |
          ssh -p "$SSH_PORT" -o StrictHostKeyChecking=yes "$SSH_USER@$SSH_HOST" "echo 'SSH OK'"

      - name: Check deploy dir is writable
        shell: bash
        run: |
          set -euo pipefail
          if ! ssh -p "$SSH_PORT" -o StrictHostKeyChecking=yes "$SSH_USER@$SSH_HOST" "test -w \"$DEPLOY_DIR\""; then
            echo "No write access to $DEPLOY_DIR on $SSH_HOST for user $SSH_USER. Create it and grant write permissions, then re-run deploy." >&2
            exit 1
          fi

      - name: Sync backend to server
        run: |
          rsync -azv --delete \
            --exclude ".gradle/" --exclude "build/" --exclude ".idea/" --exclude "out/" \
            --omit-dir-times --no-perms --no-owner --no-group \
            -e "ssh -p $SSH_PORT -o StrictHostKeyChecking=yes" \
            ./backend/ "$SSH_USER@$SSH_HOST:$DEPLOY_DIR/"

      - name: Remote build + restart container
        run: |
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" <<'EOF'
          set -e
          ENV_FILE="/opt/growerhub/env/growerhub-java-backend.env"
          if ! sudo -n /usr/bin/test -d /; then
            echo "sudo NOPASSWD is not configured for watering-admin (needs test/grep/docker/curl)" >&2
            exit 1
          fi
          if ! sudo -n /usr/bin/test -f "$ENV_FILE"; then
            echo "Env file is missing: $ENV_FILE" >&2
            exit 1
          fi
          if ! sudo -n /usr/bin/grep -Eq '^SECRET_KEY=.+$' "$ENV_FILE"; then
            echo "SECRET_KEY is missing or empty in $ENV_FILE" >&2
            exit 1
          fi
          if ! sudo -n /usr/bin/grep -Eq '^SPRING_DATASOURCE_URL=.+$' "$ENV_FILE"; then
            echo "SPRING_DATASOURCE_URL is missing or empty in $ENV_FILE" >&2
            exit 1
          fi
          if ! sudo -n /usr/bin/grep -Eq '^SPRING_DATASOURCE_USERNAME=.+$' "$ENV_FILE"; then
            echo "SPRING_DATASOURCE_USERNAME is missing or empty in $ENV_FILE" >&2
            exit 1
          fi
          if ! sudo -n /usr/bin/grep -Eq '^SPRING_DATASOURCE_PASSWORD=.+$' "$ENV_FILE"; then
            echo "SPRING_DATASOURCE_PASSWORD is missing or empty in $ENV_FILE" >&2
            exit 1
          fi
          if sudo -n /usr/bin/grep -Eq '^MQTT_HOST=.+$' "$ENV_FILE"; then
            if ! sudo -n /usr/bin/grep -Eq '^MQTT_PORT=.+$' "$ENV_FILE"; then
              echo "MQTT_PORT is missing or empty in $ENV_FILE (MQTT_HOST is set)" >&2
              exit 1
            fi
            if sudo -n /usr/bin/grep -Eq '^MQTT_USERNAME=' "$ENV_FILE" || sudo -n /usr/bin/grep -Eq '^MQTT_PASSWORD=' "$ENV_FILE"; then
              if ! sudo -n /usr/bin/grep -Eq '^MQTT_USERNAME=.+$' "$ENV_FILE"; then
                echo "MQTT_USERNAME is missing or empty in $ENV_FILE (MQTT auth enabled)" >&2
                exit 1
              fi
              if ! sudo -n /usr/bin/grep -Eq '^MQTT_PASSWORD=.+$' "$ENV_FILE"; then
                echo "MQTT_PASSWORD is missing or empty in $ENV_FILE (MQTT auth enabled)" >&2
                exit 1
              fi
            fi
          fi
          sudo -n /usr/bin/docker build -t growerhub-backend:local /opt/growerhub/java-backend
          sudo -n /usr/bin/docker rm -f growerhub-java-backend || true
          sudo -n /usr/bin/docker run -d --name growerhub-java-backend --restart unless-stopped \
            --env-file "$ENV_FILE" \
            -p 127.0.0.1:18080:8080 \
            growerhub-backend:local
          sudo -n /usr/bin/docker ps --filter name=growerhub-java-backend
          if ! sudo -n /usr/bin/docker inspect growerhub-java-backend \
            --format '{{range .Config.Env}}{{println .}}{{end}}' \
            | grep -q '^SECRET_KEY='; then
            echo "SECRET_KEY is not present in container env" >&2
            exit 1
          fi
          if ! sudo -n /usr/bin/docker inspect growerhub-java-backend \
            --format '{{range .Config.Env}}{{println .}}{{end}}' \
            | grep -q '^SPRING_DATASOURCE_URL='; then
            echo "SPRING_DATASOURCE_URL is not present in container env" >&2
            exit 1
          fi
          sudo -n /usr/bin/docker inspect growerhub-java-backend \
            --format '{{range .Config.Env}}{{println .}}{{end}}' \
            | sed -E 's/=(.*)$/=***MASKED***/' \
            | grep -E '^(SECRET_KEY|SPRING_DATASOURCE_URL)=' || true

          ok=0
          for i in $(seq 1 30); do
            if sudo -n /usr/bin/curl -fsS http://127.0.0.1:18080/health >/tmp/health.json 2>/tmp/health.err; then
              ok=1
              sudo -n /usr/bin/cat /tmp/health.json
              break
            fi
            echo "healthcheck attempt $i failed: $(sudo -n /usr/bin/cat /tmp/health.err 2>/dev/null || true)"
            sleep 1
          done

          if [ "$ok" -ne 1 ]; then
            sudo -n /usr/bin/docker ps --filter name=growerhub-java-backend
            sudo -n /usr/bin/docker logs --tail=200 growerhub-java-backend || true
            exit 1
          fi
          EOF
