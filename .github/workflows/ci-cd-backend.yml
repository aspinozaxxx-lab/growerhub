name: CI/CD Backend (Java)

on:
  pull_request:
    paths:
      - "backend/**"
  push:
    branches: [ "main" ]
    paths:
      - "backend/**"
  workflow_dispatch:

jobs:
  ci:
    name: CI (java backend)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle (with cache)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.10.2"

      - name: Gradle test
        working-directory: backend
        run: gradle --no-daemon test

      - name: Gradle build
        working-directory: backend
        run: gradle --no-daemon build -x test

      - name: Docker build
        working-directory: backend
        run: docker build -t growerhub-backend:ci .

  deploy:
    name: Deploy to production (java backend)
    runs-on: ubuntu-latest
    needs: [ ci ]
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    permissions:
      contents: read
    environment:
      name: production
      url: https://growerhub.ru/health
    env:
      DEPLOY_HOST: ${{ vars.DEPLOY_HOST }}
      DEPLOY_PORT: ${{ vars.DEPLOY_PORT }}
      DEPLOY_USER: ${{ vars.DEPLOY_USER }}
      DEPLOY_DIR: /opt/growerhub/java-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          install -m 700 -d ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "$DEPLOY_PORT" "$DEPLOY_HOST" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: SSH smoke test
        run: |
          ssh -p "$DEPLOY_PORT" -o StrictHostKeyChecking=yes "$DEPLOY_USER@$DEPLOY_HOST" "echo 'SSH OK'"

      - name: Ensure target dir exists
        run: |
          ssh -p "$DEPLOY_PORT" -o StrictHostKeyChecking=yes "$DEPLOY_USER@$DEPLOY_HOST" <<'EOF'
          set -e
          sudo mkdir -p /opt/growerhub/java-backend
          sudo chown -R "$(id -un):$(id -gn)" /opt/growerhub/java-backend
          sudo chmod 755 /opt/growerhub /opt/growerhub/java-backend
          EOF

      - name: Sync backend to server
        run: |
          rsync -azv --delete \
            --exclude ".gradle/" --exclude "build/" --exclude ".idea/" --exclude "out/" \
            --omit-dir-times --no-perms --no-owner --no-group \
            -e "ssh -p $DEPLOY_PORT -o StrictHostKeyChecking=yes" \
            ./backend/ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_DIR/"

      - name: Remote build + restart container
        run: |
          ssh -p "$DEPLOY_PORT" "$DEPLOY_USER@$DEPLOY_HOST" <<'EOF'
          set -e
          docker build -t growerhub-backend:local /opt/growerhub/java-backend
          docker rm -f growerhub-java-backend || true
          docker run -d --name growerhub-java-backend --restart unless-stopped -p 127.0.0.1:18080:8080 growerhub-backend:local
          docker ps --filter name=growerhub-java-backend
          curl -fsS http://127.0.0.1:18080/health
          EOF
