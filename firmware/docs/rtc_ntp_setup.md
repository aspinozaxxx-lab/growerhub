# Настройка RTC и синхронизации NTP

## Подключение DS3231 к ESP32

- VCC → 3.3 V  
- GND → общий GND с ESP32  
- SDA → GPIO 21  
- SCL → GPIO 22  

Большинство модулей DS3231 уже содержит подтягивающие резисторы на линии I²C. Если их нет, установите резисторы 4.7 кОм–10 кОм к питанию.

Обязательно установите батарейку CR2032 для сохранения хода времени при отключении питания.

## Как работает синхронизация

1. При запуске SystemClock читает время из RTC (если модуль доступен).  
2. После старта выполняются до трех попыток синхронизации с NTP.  
3. При успешной синхронизации SystemClock записывает время обратно в DS3231 и повторяет процесс каждые 6 часов.  
4. Если RTC отсутствует или модуль NTP недоступен, прошивка продолжает работу на основе системных таймеров — функциональность не ломается, но абсолютное время может быть недоступно.

## Включение отладочного вывода

Для временной диагностики можно включить Serial-логи:

- В файле `src/System/SystemClock.h` установите `#define GH_CLOCK_DEBUG 1` (верните значение обратно после проверки).
- Либо добавьте в `platformio.ini` для нужного окружения:  
  ```
  build_flags =
      -DGH_CLOCK_DEBUG=1
  ```

После прошивки откройте Serial @115200 и наблюдайте сообщения `[CLOCK]`.

## Изменение сервера и интервалов NTP

В начале `src/System/SystemClock.h` объявлены константы:

- `NTP_SERVER` — адрес сервера NTP (по умолчанию `pool.ntp.org`).  
- `NTP_RETRY_INTERVAL_MS` — задержка перед повторной попыткой, если синхронизация не удалась (30 секунд).  
- `NTP_RESYNC_INTERVAL_MS` — периодическая повторная синхронизация (6 часов).  
- `SUSPICIOUS_THRESHOLD_SEC` — порог “подозрительного” сдвига (31 день).  
- `RTC_SDA_PIN` и `RTC_SCL_PIN` — пины I²C для модуля DS3231.

При необходимости скорректируйте значения под свою схему.

## Чек-лист перед стартом

- Установлена батарейка CR2032 в модуле DS3231.  
- Подтягивающие резисторы I²C присутствуют (обычно уже на модуле).  
- Общий GND между ESP32 и DS3231.  
- SDA → GPIO 21, SCL → GPIO 22.  
- NTP-сервер доступен из вашей сети (по умолчанию `pool.ntp.org`).

## Если RTC отсутствует

SystemClock автоматически работает без внешнего RTC: время хранится только в системном таймере ESP32, а синхронизация с сервером выполняется как обычно. Добавление DS3231 позволяет иметь актуальное время даже без сети.
